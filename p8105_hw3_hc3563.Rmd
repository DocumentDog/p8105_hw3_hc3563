---
title: "p8015_hw3_hc3563"
author: "Hanchuan Chen"
date: "2024-10-10"
output: github_document
---
```{r message=FALSE}
library(tidyverse)
library(patchwork)
library(ggridges)
```

### Problem 1

### Problem 2
```{r merge_data, message=FALSE}
covar_df = 
  read_csv("./data/nhanes_covar.csv", skip=4) |> 
  janitor::clean_names()

accel_df = 
  read_csv("./data/nhanes_accel.csv") |> 
  janitor::clean_names()

# merge dataset first, then do data cleaning
nhanes_df = left_join(covar_df, accel_df, by="seqn")
nhanes_df = 
  nhanes_df |> 
  filter(age >= 21) |> 
  mutate(sex = factor(sex, levels=c(1,2), labels=c("M","F"))) |> 
  mutate(education = factor(education, levels=c(1,2,3), labels=c("low","medium","high"))) |> 
  drop_na(bmi, education)
```

```{r education_table, message=FALSE}
education_df = 
  nhanes_df |> 
  group_by(sex, education) |> 
  summarize(n_obs=n())

knitr::kable(education_df)
```

```{r age_distribution, message=FALSE}
age_dist_M = 
  nhanes_df |> 
  filter(sex == "M") |> 
  ggplot(aes(x=education, y=age)) + 
  geom_boxplot() +
  labs(
    title = "age distribution by education for male"
  )
  
age_dist_F =
  nhanes_df |> 
  filter(sex == "F") |> 
  ggplot(aes(x=education, y=age)) + 
  geom_boxplot() +
  labs(
    title = "age distribution by education for female"
  )  

print(age_dist_M)
print(age_dist_F)
```

By looking at the distribution of age by sex and education, generally speaking older people tend to have lower education degree and young people have higher education degree. To compare the female and male, there are more female had medium degree, which is high school equivalent, than male had. 

```{r message=FALSE}
nhanes_df = 
  nhanes_df |> 
  mutate(total = rowSums(select(nhanes_df,min1:min1440)))

ggplot(nhanes_df, aes(x = age, y = total)) +
  geom_point(aes(color = sex)) +
  geom_smooth(method="lm", se = FALSE) +
  facet_wrap(~education) +
  labs(
    title = "Total Activity vs. Age by Sex and Education",
    x = "Age (years)",
    y = "Total Daily Activity",
    color = "Sex"
  )
```
From these plots, we can see that older people have less total daily activity than young people, but there is no significant relationship between sex and total activity. Also, people with lower education have more activity in young age than medium and high education people but have less activity when they getting old.

```{r}
df_long = 
  pivot_longer(
    nhanes_df,
    min1:min1440,
    names_to = "minute",
    names_prefix = "min",
    values_to = "activity"
  )

df_long =
  df_long |> mutate(minute = as.numeric(minute))

plt = 
  ggplot(df_long, aes(x=minute, y=activity, color=sex)) +
  geom_hex() +
  geom_smooth(se = FALSE) +
  facet_wrap(~education) +
  labs(
    title = "Scatter Plot of Activity Over 24 Hours by Sex",
    x = "Minute of the Day",
    y = "Activity Level",
    color = "Sex"
  ) +
  scale_x_continuous(
    breaks = seq(0, 1440, by = 240),  # Label x-axis at 4-hour intervals
    labels = c("12 AM", "4 AM", "8 AM", "12 PM", "4 PM", "8 PM", "12 AM")
  )

print(plt)
```
According to this hex plot, we can see that no matter education level, people tend to have less activity between 12 am and 6 am with the least activity at 4 am. Also, male usually have most activity at 9 am, while female have most activity at 8 pm. As we compare the education level, the distribution of activity between low and medium is similar, while high education level have overall more activity than the other two levels. The peak activity for male and female for high education level is much higher than low and medium levels.


### Problem 3
```{r import_dataset, message=FALSE}
jan_2020_citi = 
  read_csv("./data/citibike/Jan 2020 Citi.csv") |> 
  drop_na()
jan_2024_citi = 
  read_csv("./data/citibike/Jan 2024 Citi.csv") |> 
  drop_na()
july_2020_citi = 
  read_csv("./data/citibike/July 2020 Citi.csv") |> 
  drop_na()
july_2024_citi = 
  read_csv("./data/citibike/July 2024 Citi.csv") |> 
  drop_na()
```

These datasets contains 1% of all rides with a total duration less than 4 hours in each of four months: January 2020, January 2024, July 2020, and July 2024. Each dataset has the same variables: ride_id, ridable_type, weekdays, duration, start_station, end_station, member_casual. ride_id provides the unique key, ridable_type is if people ride on classical or electrical bike, member_casual indicates if people riding the Citibike are members or not.

This table shows the total number of rides in each combination of year and month separating casual riders and Citi Bike members:
```{r}
jan_2020_member = 
  jan_2020_citi |> 
  group_by(member_casual) |> 
  summarize(n_obs=n()) |> 
  mutate(month = "Jan") |> 
  mutate(year = "2020")

jan_2024_member = 
  jan_2024_citi |> 
  group_by(member_casual) |> 
  summarize(n_obs=n()) |> 
  mutate(month = "Jan") |> 
  mutate(year = "2024")

july_2020_member = 
  july_2020_citi |> 
  group_by(member_casual) |> 
  summarize(n_obs=n()) |> 
  mutate(month = "July") |> 
  mutate(year = "2020")

july_2024_member = 
  july_2024_citi |> 
  group_by(member_casual) |> 
  summarize(n_obs=n()) |> 
  mutate(month = "July") |> 
  mutate(year = "2024")

sum_member_table = 
  bind_rows(jan_2020_member, july_2020_member, jan_2024_member, july_2024_member)

knitr::kable(sum_member_table)
```
From this table, we can know that there are more Citibike members than casual riders, while both the number of them increase from 2020 to 2024. Moreover, people who ride the Citibike tend to go out in July than in January. 

This table shows the 5 most popular starting stations for July 2024:
```{r}
july_2024_popular_start = 
  july_2024_citi |> 
  group_by(start_station_name) |> 
  summarize(n_obs=n()) |> 
  arrange(-n_obs)

knitr::kable(head(july_2024_popular_start, 5))
```

The plot below shows the effects of day of the week, month, and year on median ride duration:
```{r}
# add month and year for each dataset and bind them together
jan_2020_citi = 
  jan_2020_citi |> 
  mutate(month = "Jan") |> 
  mutate(year = "2020")

jan_2024_citi = 
  jan_2024_citi |> 
  mutate(month = "Jan") |> 
  mutate(year = "2024")

july_2020_citi = 
  july_2020_citi |> 
  mutate(month = "July") |> 
  mutate(year = "2020")

july_2024_citi = 
  july_2024_citi |> 
  mutate(month = "July") |> 
  mutate(year = "2024")

citibike_df = 
  bind_rows(jan_2020_citi, july_2020_citi, jan_2024_citi, july_2024_citi)

# calculate the median ride duration for day of week and plot it
weekdays_median = 
  citibike_df |> 
  group_by(weekdays) |> 
  summarize(median_duration = median(duration)) |> 
  ggplot(aes(x=weekdays, y=median_duration)) +
  geom_bar(stat = "identity") +
  labs(
    title = "median ride duration for day of the week",
    x = "weekdays",
    y = "median duration",
    scale_y_continuous(
      breaks = c(0,12)
    )
  )


# median ride duration for month and plot it 
month_median = 
  citibike_df |> 
  group_by(month) |> 
  summarize(median_duration = median(duration)) |> 
  ggplot(aes(x=month, y=median_duration)) +
  geom_bar(stat = "identity") +
  labs(
    title = "median ride duration for month",
    x = "month",
    y = "median duration"
  )

# median ride duration for year and plot it
year_median = 
  citibike_df |> 
  group_by(year) |> 
  summarize(median_duration = median(duration)) |> 
  ggplot(aes(x=year, y=median_duration)) +
  geom_bar(stat = "identity") +
  labs(
    title = "median ride duration for year",
    x = "year",
    y = "median duration"
  )

(year_median + month_median) / weekdays_median
```
According to these three plots, we can see the median ride duration over the year decreased, which might because people tend to treat Citibike as a short distance transportation tool instead of mid of long distance. Furthermore, July has more ride duration than Jan, which might due to the weather and temperature. January is too cold to ride while July has more suitable temperature. Moreover, from the plot of median ride duration to weekdays, it is clear that people have more ride time in weekends than in weekdays.

There are figures that show the impact of month, membership status, and bike type on the distribution of ride duration:
```{r}
month_duration_dist = 
  citibike_df |> 
  ggplot(aes(x=duration, y=month)) +
  geom_density_ridges(scale = 0.85) +
  labs(
    title = "distribution of duration for month, membership, and bike type",
    y = "month"
  )

member_duration_dist = 
  citibike_df |> 
  ggplot(aes(x=duration, y=member_casual)) +
  geom_density_ridges(scale = 0.85) +
  labs(
    y = "membership"
  )

bike_duration_dist = 
  citibike_df |> 
  ggplot(aes(x=duration, y=rideable_type)) +
  geom_density_ridges(scale = 0.85) +
  labs(
    y = "bike type"
  )

month_duration_dist / member_duration_dist / bike_duration_dist
```

From the plots above, we can see that all of the plots are right-skewed, representing that although half of people have ride duration in about 10 minutes, there are still many of people ride bike for over an hour. For the plot of month to ride duration, more people tend to ride less time in January than in July; for membership, there are more casual rider ride for longer time than people who have membership; there is no significant difference between electric bike user and classic bike user, but more people prefer to use electric bike.















